<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Parent Dashboard - School Management System</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
      /* Custom styles for parent dashboard */
      .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 1rem;
        border-radius: 0 0 1rem 1rem;
        min-height: 70px;
        display: flex;
        align-items: center;
      }

      .hero-section .container {
        padding-top: 0;
        padding-bottom: 0;
      }

      .hero-section h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .hero-section p {
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      .hero-section .row .col-auto {
        padding: 0.25rem;
      }

      .hero-section .d-flex {
        font-size: 0.8rem;
      }

      .search-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        padding: 1rem;
        margin-bottom: 0.75rem;
      }

      .search-input {
        border: 2px solid #e1e5e9;
        border-radius: 50px;
        padding: 0.375rem 1rem;
        font-size: 0.85rem;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.1rem rgba(102, 126, 234, 0.25);
        outline: none;
      }

      .pupil-card {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 0.75rem;
      }

      .pupil-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.12);
      }

      .pupil-card.selected {
        border: 2px solid #667eea;
        background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
      }

      .info-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        padding: 1rem;
        margin-bottom: 0.75rem;
      }

      .fees-balance {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: center;
      }

      .attendance-card {
        background: linear-gradient(135deg, #00d2d3, #54a0ff);
        color: white;
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: center;
      }

      .payment-item {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-left: 3px solid #28a745;
      }

      .loading-spinner {
        display: none;
        justify-content: center;
        align-items: center;
        min-height: 120px;
      }

      .no-results {
        text-align: center;
        color: #6c757d;
        padding: 1.5rem;
      }

      @media (max-width: 576px) {
        .hero-section {
          padding: 1rem 0;
          min-height: 60px;
        }

        .hero-section h1 {
          font-size: 1.25rem;
        }

        .hero-section p {
          font-size: 0.8rem;
        }

        .search-container {
          padding: 0.75rem;
        }

        .info-section {
          padding: 0.75rem;
        }

        .fees-balance, .attendance-card {
          padding: 0.5rem;
        }

        .stat-number {
          font-size: 1.1rem;
        }
      }

      .stat-number {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.75rem;
        opacity: 0.9;
      }

      /* Report Card Styles */
      .report-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: none;
        border-radius: 1rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.15);
      }

      .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
      }

      .report-meta {
        margin-top: 0.5rem;
      }

      .report-meta .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
      }

      .overall-score {
        text-align: center;
      }

      .score-circle {
        display: inline-block;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: 3px solid white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
      }

      .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
      }

      .score-label {
        font-size: 0.7rem;
        opacity: 0.9;
        margin-top: 2px;
      }

      .subjects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        padding: 1.5rem;
        background: #f8f9fa;
      }

      .subject-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
      }

      .subject-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
      }

      .subject-card.english { border-left-color: #28a745; }
      .subject-card.mathematics { border-left-color: #007bff; }
      .subject-card.science { border-left-color: #fd7e14; }
      .subject-card.social-studies { border-left-color: #6f42c1; }

      .subject-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #495057;
      }

      .subject-header i {
        font-size: 1.2rem;
      }

      .subject-score {
        font-size: 1.5rem;
        font-weight: bold;
        color: #212529;
        margin-bottom: 0.25rem;
      }

      .subject-grade {
        display: inline-block;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
      }

      .subject-remark {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        line-height: 1.3;
      }

      .performance-summary {
        padding: 1.5rem;
        background: white;
      }

      .summary-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: #f8f9fa;
        border-radius: 0.75rem;
        padding: 1rem;
        height: 100%;
      }

      .summary-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .summary-content h6 {
        margin: 0 0 0.5rem 0;
        color: #495057;
        font-weight: 600;
      }

      .position-text {
        font-size: 1.1rem;
        color: #212529;
        margin-bottom: 0.25rem;
      }

      .comment-text {
        color: #495057;
        line-height: 1.4;
      }

      .report-footer {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
      }

      .total-score {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .total-label {
        font-weight: 600;
        color: #495057;
      }

      .total-value {
        font-size: 1.25rem;
        font-weight: bold;
        color: #212529;
      }

      @media (max-width: 768px) {
        .subjects-grid {
          grid-template-columns: 1fr;
          gap: 0.75rem;
          padding: 1rem;
        }

        .report-header {
          padding: 1rem;
        }

        .score-circle {
          width: 60px;
          height: 60px;
        }

        .score-number {
          font-size: 1.2rem;
        }

        .performance-summary {
          padding: 1rem;
        }

        .summary-card {
          flex-direction: column;
          text-align: center;
          gap: 0.75rem;
        }

        .summary-icon {
          width: 40px;
          height: 40px;
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="height: 32px; width: auto;">
          {{ system_settings.abbreviated_school_name }}
        </a>
        <div class="ms-auto">
          <a href="{{ url_for('user.logout') }}" class="btn btn-danger text-white d-flex align-items-center">
            <i class="bi bi-box-arrow-right me-2"></i>
            Logout
          </a>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            <h1 class="display-4 fw-bold mb-3">
              <i class="bi bi-house-heart-fill me-3"></i>
              Welcome to Parent Portal
            </h1>
            <p class="lead mb-4">
              Monitor your child's academic progress, view payment history, and stay connected with their educational journey.
            </p>
            <div class="row g-3 justify-content-center">
              <div class="col-auto">
                <div class="d-flex align-items-center">
                  <i class="bi bi-search text-warning me-2 fs-5"></i>
                  <span>Search Students</span>
                </div>
              </div>
              <div class="col-auto">
                <div class="d-flex align-items-center">
                  <i class="bi bi-receipt text-success me-2 fs-5"></i>
                  <span>View Payments</span>
                </div>
              </div>
              <div class="col-auto">
                <div class="d-flex align-items-center">
                  <i class="bi bi-calendar-check text-info me-2 fs-5"></i>
                  <span>Check Attendance</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main class="container px-2 px-md-3">
      <!-- Search Section -->
      <div class="search-container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h3 class="text-center mb-4">
              <i class="bi bi-search me-2 text-primary"></i>
              Find Your Child
            </h3>
            <div class="input-group input-group-lg">
              <input type="text" class="form-control search-input" id="pupilSearch"
                     placeholder="Search by name, admission number, or roll number..."
                     autocomplete="off">
              <button class="btn btn-primary" type="button" id="searchBtn">
                <i class="bi bi-search me-2"></i>
                Search
              </button>
            </div>
            <small class="form-text text-muted text-center mt-2">
              Enter first name, last name, admission number, or roll number
            </small>
          </div>
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="mt-4" style="display: none;">
          <h5 class="mb-3">
            <i class="bi bi-list-ul me-2"></i>
            Search Results
          </h5>
          <div id="pupilList" class="row g-3">
            <!-- Pupil cards will be inserted here -->
          </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="ms-3">Searching pupils...</div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="no-results" style="display: none;">
          <i class="bi bi-search fs-1 text-muted mb-3"></i>
          <h5>No pupils found</h5>
          <p>Try searching with a different name or number</p>
        </div>
      </div>

      <!-- Pupil Details Section -->
      <div id="pupilDetails" style="display: none;">
        <!-- Pupil Header -->
        <div class="info-section">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h3 id="pupilName" class="mb-2"></h3>
              <div class="row g-3">
                <div class="col-auto">
                  <small class="text-muted">Admission No:</small>
                  <div class="fw-bold" id="admissionNumber"></div>
                </div>
                <div class="col-auto">
                  <small class="text-muted">Roll No:</small>
                  <div class="fw-bold" id="rollNumber"></div>
                </div>
                <div class="col-auto">
                  <small class="text-muted">Class:</small>
                  <div class="fw-bold" id="pupilClass"></div>
                </div>
                <div class="col-auto">
                  <small class="text-muted">Stream:</small>
                  <div class="fw-bold" id="pupilStream"></div>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-outline-primary" onclick="refreshPupilData()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Fees Balance & Attendance -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="fees-balance">
              <div class="stat-number" id="feesBalance">0.00</div>
              <div class="stat-label">Fees Balance (KES)</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="attendance-card">
              <div class="stat-number" id="attendancePercentage">0%</div>
              <div class="stat-label">Monthly Attendance</div>
            </div>
          </div>
        </div>

        <!-- Detailed Information Tabs -->
        <div class="info-section">
          <ul class="nav nav-tabs" id="pupilTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                <i class="bi bi-receipt me-2"></i>
                Payment History
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                <i class="bi bi-calendar-check me-2"></i>
                Attendance
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                <i class="bi bi-file-earmark-text me-2"></i>
                Reports
              </button>
            </li>
          </ul>

          <div class="tab-content mt-3" id="pupilTabsContent">
            <!-- Payment History Tab -->
            <div class="tab-pane fade show active" id="payments" role="tabpanel">
              <h5 class="mb-3">Recent Payments</h5>
              <div id="paymentsList">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-receipt fs-1 mb-3"></i>
                  <p>Loading payment history...</p>
                </div>
              </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
              <h5 class="mb-3">Attendance Summary</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="card text-center">
                    <div class="card-body py-2">
                      <h6 class="card-title text-primary mb-1" style="font-size: 0.8rem;">Daily (7 days)</h6>
                      <div class="stat-number" id="dailyAttendance">0%</div>
                      <small class="text-muted" id="dailyStats" style="font-size: 0.7rem;">0/0 days</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center">
                    <div class="card-body py-2">
                      <h6 class="card-title text-success mb-1" style="font-size: 0.8rem;">Weekly (Month)</h6>
                      <div class="stat-number" id="weeklyAttendance">0%</div>
                      <small class="text-muted" id="weeklyStats" style="font-size: 0.7rem;">0/0 days</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card text-center">
                    <div class="card-body py-2">
                      <h6 class="card-title text-info mb-1" style="font-size: 0.8rem;">Termly (3 months)</h6>
                      <div class="stat-number" id="termlyAttendance">0%</div>
                      <small class="text-muted" id="termlyStats" style="font-size: 0.7rem;">0/0 days</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
              <h5 class="mb-3">Academic Reports</h5>

              <!-- Filter Controls -->
              <div class="row g-2 mb-3" id="reportFilters" style="display: none;">
                <div class="col-md-3 col-sm-6">
                  <select class="form-select form-select-sm" id="filterYear">
                    <option value="">Select Academic Year</option>
                  </select>
                </div>
                <div class="col-md-3 col-sm-6">
                  <select class="form-select form-select-sm" id="filterExamType">
                    <option value="">Select Exam Type</option>
                  </select>
                </div>
                <div class="col-md-3 col-sm-6">
                  <select class="form-select form-select-sm" id="filterTerm">
                    <option value="">Select Term</option>
                  </select>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="d-grid">
                    <button class="btn btn-primary btn-sm" id="loadReportsBtn">
                      <i class="bi bi-search me-1"></i>Load Reports
                    </button>
                  </div>
                </div>
              </div>

              <!-- Reports Display -->
              <div id="reportsContainer">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-file-earmark-text fs-1 mb-3"></i>
                  <p>Select a pupil to view academic reports</p>
                  <small>Reports will show grades, marks, and academic progress</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    {% include 'base.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let selectedPupilId = null;
      let searchTimeout = null;

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('pupilSearch');
        const searchBtn = document.getElementById('searchBtn');

        // Search on input with debounce
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            performSearch(this.value);
          }, 300);
        });

        // Search on button click
        searchBtn.addEventListener('click', function() {
          performSearch(searchInput.value);
        });

        // Search on Enter key
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performSearch(this.value);
          }
        });
      });

      function performSearch(query) {
        if (!query.trim()) {
          hideSearchResults();
          return;
        }

        showLoading();

        fetch(`/parent/api/search_pupils?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.success) {
              displaySearchResults(data.pupils);
            } else {
              showError('Search failed: ' + data.message);
            }
          })
          .catch(error => {
            hideLoading();
            showError('Search error: ' + error.message);
          });
      }

      function displaySearchResults(pupils) {
        const resultsDiv = document.getElementById('searchResults');
        const pupilList = document.getElementById('pupilList');
        const noResults = document.getElementById('noResults');

        if (pupils.length === 0) {
          resultsDiv.style.display = 'none';
          noResults.style.display = 'block';
          return;
        }

        noResults.style.display = 'none';
        pupilList.innerHTML = '';

        pupils.forEach(pupil => {
          const pupilCard = document.createElement('div');
          pupilCard.className = 'col-md-6 col-lg-4';
          pupilCard.innerHTML = `
            <div class="pupil-card card h-100" onclick="selectPupil('${pupil.id}')">
              <div class="card-body text-center">
                <div class="avatar-circle mx-auto mb-3">
                  <i class="bi bi-person-circle fs-1 text-primary"></i>
                </div>
                <h6 class="card-title mb-2">${pupil.full_name}</h6>
                <div class="text-muted small">
                  <div>Adm: ${pupil.admission_number || 'N/A'}</div>
                  <div>Roll: ${pupil.roll_number || 'N/A'}</div>
                  <div>Class: ${pupil.class_admitted || 'N/A'}</div>
                  <div>Stream: ${pupil.stream || 'N/A'}</div>
                </div>
              </div>
            </div>
          `;
          pupilList.appendChild(pupilCard);
        });

        resultsDiv.style.display = 'block';
      }

      function selectPupil(pupilId) {
        selectedPupilId = pupilId;

        // Update UI to show selected pupil
        document.querySelectorAll('.pupil-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        // Load pupil details
        loadPupilDetails(pupilId);
      }

      function loadPupilDetails(pupilId) {
        showLoading();

        fetch(`/parent/api/pupil/${pupilId}`)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.success) {
              displayPupilDetails(data.pupil);
            } else {
              showError('Failed to load pupil details: ' + data.message);
            }
          })
          .catch(error => {
            hideLoading();
            showError('Error loading pupil details: ' + error.message);
          });
      }

      function displayPupilDetails(pupil) {

        document.getElementById('pupilName').textContent = `${pupil.first_name} ${pupil.last_name}`;
        document.getElementById('admissionNumber').textContent = pupil.admission_number || 'N/A';
        document.getElementById('rollNumber').textContent = pupil.roll_number || 'N/A';
        document.getElementById('pupilClass').textContent = pupil.class_admitted || 'N/A';
        document.getElementById('pupilStream').textContent = pupil.stream || 'N/A';

        // Update fees balance
        document.getElementById('feesBalance').textContent = pupil.fees_balance.toLocaleString();

        // Update attendance summary
        const attendance = pupil.attendance_summary;
        document.getElementById('attendancePercentage').textContent = `${attendance.weekly.percentage}%`;
        document.getElementById('dailyAttendance').textContent = `${attendance.daily.percentage}%`;
        document.getElementById('dailyStats').textContent = `${attendance.daily.present}/${attendance.daily.total} days`;
        document.getElementById('weeklyAttendance').textContent = `${attendance.weekly.percentage}%`;
        document.getElementById('weeklyStats').textContent = `${attendance.weekly.present}/${attendance.weekly.total} days`;
        document.getElementById('termlyAttendance').textContent = `${attendance.termly.percentage}%`;
        document.getElementById('termlyStats').textContent = `${attendance.termly.present}/${attendance.termly.total} days`;

        // Update payments list
        const paymentsList = document.getElementById('paymentsList');
        if (pupil.recent_payments.length === 0) {
          paymentsList.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="bi bi-receipt fs-1 mb-3"></i>
              <p>No payment records found</p>
            </div>
          `;
        } else {
          paymentsList.innerHTML = pupil.recent_payments.map(payment => `
            <div class="payment-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">KES ${payment.amount.toLocaleString()}</div>
                  <small class="text-muted">${payment.payment_date} â€¢ Term ${payment.term}</small>
                </div>
                <div class="text-end">
                  <div class="badge bg-success">${payment.payment_method}</div>
                  <div class="small text-muted mt-1">Receipt: ${payment.receipt_number || 'N/A'}</div>
                </div>
              </div>
            </div>
          `).join('');
        }

        // Show pupil details section
        document.getElementById('pupilDetails').style.display = 'block';

        // Load reports for this pupil
        loadReports(selectedPupilId);

        // Scroll to details
        document.getElementById('pupilDetails').scrollIntoView({ behavior: 'smooth' });
      }

      function refreshPupilData() {
        if (selectedPupilId) {
          loadPupilDetails(selectedPupilId);
          loadReports(selectedPupilId);
        }
      }

      function loadReports(pupilId) {
        const filtersDiv = document.getElementById('reportFilters');
        const reportsContainer = document.getElementById('reportsContainer');

        showLoading();

        fetch(`/parent/api/pupil/${pupilId}/reports`)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.success) {
              // Populate filter dropdowns
              populateFilters(data.filters);
              // Display reports
              displayReports(data.reports);
              filtersDiv.style.display = 'grid';
            } else {
              reportsContainer.innerHTML = `<div class="alert alert-danger">Failed to load reports</div>`;
            }
          })
          .catch(error => {
            hideLoading();
            reportsContainer.innerHTML = `<div class="alert alert-danger">Error loading reports: ${error.message}</div>`;
          });
      }

      function populateFilters(filters) {
        const yearSelect = document.getElementById('filterYear');
        const examTypeSelect = document.getElementById('filterExamType');
        const termSelect = document.getElementById('filterTerm');

        // Clear existing options (except first)
        yearSelect.innerHTML = '<option value="">All Years</option>';
        examTypeSelect.innerHTML = '<option value="">All Exam Types</option>';
        termSelect.innerHTML = '<option value="">All Terms</option>';

        // Add academic years
        filters.academic_years.forEach(year => {
          const option = document.createElement('option');
          option.value = year.id;
          option.textContent = year.name;
          yearSelect.appendChild(option);
        });

        // Add exam types
        filters.exam_types.forEach(examType => {
          const option = document.createElement('option');
          option.value = examType;
          option.textContent = examType;
          examTypeSelect.appendChild(option);
        });

        // Add terms
        filters.terms.forEach(term => {
          const option = document.createElement('option');
          option.value = term;
          option.textContent = `Term ${term}`;
          termSelect.appendChild(option);
        });

        // Add event listener for load reports button
        document.getElementById('loadReportsBtn').addEventListener('click', applyFilters);
      }

      function applyFilters() {
        const yearSelect = document.getElementById('filterYear');
        const examTypeSelect = document.getElementById('filterExamType');
        const termSelect = document.getElementById('filterTerm');

        // Check if at least one filter is selected
        if (!yearSelect.value && !examTypeSelect.value && !termSelect.value) {
          alert('Please select at least one filter option before loading reports.');
          return;
        }

        const params = new URLSearchParams();
        if (yearSelect.value) params.append('academic_year_id', yearSelect.value);
        if (examTypeSelect.value) params.append('exam_type', examTypeSelect.value);
        if (termSelect.value) params.append('term', termSelect.value);

        showLoading();

        fetch(`/parent/api/pupil/${selectedPupilId}/reports?${params.toString()}`)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.success) {
              displayReports(data.reports);
            } else {
              document.getElementById('reportsContainer').innerHTML = `<div class="alert alert-danger">Failed to load filtered reports</div>`;
            }
          })
          .catch(error => {
            hideLoading();
            document.getElementById('reportsContainer').innerHTML = `<div class="alert alert-danger">Error loading reports: ${error.message}</div>`;
          });
      }

      function resetFilters() {
        document.getElementById('filterYear').value = '';
        document.getElementById('filterExamType').value = '';
        document.getElementById('filterTerm').value = '';
        applyFilters();
      }

      function displayReports(reports) {
        const reportsContainer = document.getElementById('reportsContainer');

        if (reports.length === 0) {
          reportsContainer.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-file-earmark-x fs-1 mb-3 text-warning"></i>
              <h5>No reports found</h5>
              <p>Try adjusting your filter criteria or select different options.</p>
            </div>
          `;
          return;
        }

        reportsContainer.innerHTML = reports.map(report => `
          <div class="report-card mb-4">
            <!-- Report Header -->
            <div class="report-header">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="mb-1">
                    <i class="bi bi-file-earmark-text-fill me-2"></i>
                    ${report.exam_type || 'Exam'} Report
                  </h5>
                  <div class="report-meta">
                    <span class="badge bg-primary me-2">${report.academic_year || 'N/A'}</span>
                    <span class="badge bg-secondary me-2">Term ${report.term || 'N/A'}</span>
                    <span class="badge bg-success">${report.overall_grade || 'N/A'}</span>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <div class="overall-score">
                    <div class="score-circle">
                      <span class="score-number">${report.average || 0}%</span>
                      <span class="score-label">Average</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Subject Scores -->
            <div class="subjects-grid">
              <div class="subject-card english">
                <div class="subject-header">
                  <i class="bi bi-book"></i>
                  <span>English</span>
                </div>
                <div class="subject-score">${report.english || 0}/100</div>
                <div class="subject-grade">${report.english_grade || 'N/A'}</div>
                <div class="subject-remark">${report.english_remark || ''}</div>
              </div>

              <div class="subject-card mathematics">
                <div class="subject-header">
                  <i class="bi bi-calculator"></i>
                  <span>Mathematics</span>
                </div>
                <div class="subject-score">${report.mathematics || 0}/100</div>
                <div class="subject-grade">${report.mathematics_grade || 'N/A'}</div>
                <div class="subject-remark">${report.mathematics_remark || ''}</div>
              </div>

              <div class="subject-card science">
                <div class="subject-header">
                  <i class="bi bi-flask"></i>
                  <span>Science</span>
                </div>
                <div class="subject-score">${report.science || 0}/100</div>
                <div class="subject-grade">${report.science_grade || 'N/A'}</div>
                <div class="subject-remark">${report.science_remark || ''}</div>
              </div>

              <div class="subject-card social-studies">
                <div class="subject-header">
                  <i class="bi bi-globe"></i>
                  <span>Social Studies</span>
                </div>
                <div class="subject-score">${report.social_studies || 0}/100</div>
                <div class="subject-grade">${report.social_studies_grade || 'N/A'}</div>
                <div class="subject-remark">${report.social_studies_remark || ''}</div>
              </div>
            </div>

            <!-- Performance Summary -->
            <div class="performance-summary">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="summary-card">
                    <div class="summary-icon">
                      <i class="bi bi-trophy"></i>
                    </div>
                    <div class="summary-content">
                      <h6>Class Position</h6>
                      <div class="position-text">
                        <strong>${report.position_in_class || 'N/A'}</strong> out of ${report.class_student_count || 'N/A'}
                      </div>
                      <small class="text-muted">Stream: ${report.position_in_stream || 'N/A'} out of ${report.stream_student_count || 'N/A'}</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="summary-card">
                    <div class="summary-icon">
                      <i class="bi bi-chat-quote"></i>
                    </div>
                    <div class="summary-content">
                      <h6>Teacher's Comment</h6>
                      <div class="comment-text">${report.general_comment || 'No comment provided'}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Total Score Footer -->
            <div class="report-footer">
              <div class="total-score">
                <span class="total-label">Total Score:</span>
                <span class="total-value">${report.total_marks || 0} / 400</span>
              </div>
            </div>
          </div>
        `).join('');
      }

      function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'flex';
      }

      function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
      }

      function hideSearchResults() {
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';
      }

      function showError(message) {
        // You can implement a toast notification here
        alert(message);
      }
    </script>
  </body>
</html>
