<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>System Settings - Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
      /* Custom styles for better mobile experience */
      .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #e1e5e9;
        transition: all 0.3s ease;
      }

      .form-control:focus, .form-select:focus {
        border-color: #6c5ce7;
        box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
      }

      .card {
        background: linear-gradient(135deg, #fff5f5, #fed7d7) !important;
        border: 1px solid #feb2b2 !important;
      }

      .card-header {
        background: linear-gradient(135deg, #fc8181, #f56565) !important;
        border-bottom: 1px solid #e53e3e !important;
      }

      /* Mobile responsive improvements */
      @media (max-width: 768px) {
        .container {
          padding-left: 15px;
          padding-right: 15px;
        }

        .form-control, .form-select {
          font-size: 16px; /* Prevents zoom on iOS */
          padding: 12px 16px;
        }

        .btn {
          padding: 12px 24px;
          font-size: 16px;
        }

        .card-body {
          padding: 1.5rem 1rem;
        }

        .row {
          --bs-gutter-x: 0.5rem;
        }

        .col-md-4, .col-md-6 {
          margin-bottom: 1rem;
        }

        .card {
          margin: 0.5rem;
          border-radius: 8px;
        }

        .form-label {
          font-weight: 600;
          margin-bottom: 0.5rem;
        }

        .card-header h5 {
          font-size: 1.1rem;
        }
      }

      @media (max-width: 576px) {
        .col-md-6 {
          margin-bottom: 1rem;
        }

        .card-body {
          padding: 1rem;
        }

        .btn-group {
          flex-direction: column;
          gap: 0.5rem;
        }

        .btn-group .btn {
          width: 100%;
        }

        .navbar-fixed-top-spacer {
          height: 70px; /* Smaller navbar height for very small screens */
        }
      }

      /* Ensure navbar doesn't overlap content */
      .navbar-fixed-top-spacer {
        height: 80px; /* Reserve space for navbar */
      }
    </style>

  </head>

  <body class="bg-light">

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="height: 32px; width: auto;">
          {{ system_settings.abbreviated_school_name }}
        </a>

        <div class="ms-auto">
          <a href="{{ url_for('user.dashboard') }}" class="btn btn-light d-flex align-items-center px-2 py-1" style="font-size: 0.8rem; height: 32px;">
            <i class="bi bi-house me-1"></i>
            Dashboard
          </a>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="navbar-fixed-top-spacer"></div>
    <main class="container py-4" id="main-content">
      <!-- Bootstrap Alerts Container -->
      <div id="alerts-container"></div>

      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm" style="border: none; border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #fff5f5, #fed7d7); border: 1px solid #feb2b2;">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #fc8181, #f56565); border-bottom: 1px solid #e53e3e;">
              <h5 class="mb-0">
                <i class="bi bi-gear me-2"></i>
                System Settings
              </h5>
            </div>
            <div class="card-body">
              <form method="POST">
                <!-- General Settings -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-building me-2"></i>
                    General Settings
                  </h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label">School Name</label>
                      <input type="text" class="form-control" name="school_name" value="{{ settings.get('school_name', '') }}" placeholder="">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Abbreviated School Name</label>
                      <input type="text" class="form-control" name="abbreviated_school_name" value="{{ settings.get('abbreviated_school_name', '') }}" placeholder="">
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-12">
                      <label class="form-label">School Address</label>
                      <input type="text" class="form-control" name="school_address" value="{{ settings.get('school_address', '') }}" placeholder="Enter full school address">
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-6">
                      <label class="form-label">School Phone</label>
                      <input type="tel" class="form-control" name="school_phone" value="{{ settings.get('school_phone', '') }}" placeholder="+254 XXX XXX XXX">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">School Email</label>
                      <input type="email" class="form-control" name="school_email" value="{{ settings.get('school_email', '') }}" placeholder="school@example.com">
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-4">
                      <label class="form-label">Currency</label>
                      <select class="form-select" name="currency">
                        <option value="KES" {% if settings.get('currency') == 'KES' %}selected{% endif %}>KES (Kenyan Shilling)</option>
                        <option value="UGX" {% if settings.get('currency') == 'UGX' %}selected{% endif %}>UGX (Ugandan Shilling)</option>
                        <option value="TZS" {% if settings.get('currency') == 'TZS' %}selected{% endif %}>TZS (Tanzanian Shilling)</option>
                        <option value="USD" {% if settings.get('currency') == 'USD' %}selected{% endif %}>USD (US Dollar)</option>
                        <option value="EUR" {% if settings.get('currency') == 'EUR' %}selected{% endif %}>EUR (Euro)</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Current Academic Year</label>
                      <select class="form-select" name="academic_year">
                        <option value="">Select Academic Year</option>
                        {% for year in academic_years %}
                        <option value="{{ year.name }}" {% if settings.get('academic_year') == year.name %}selected{% endif %}>{{ year.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Timezone</label>
                      <select class="form-select" name="timezone">
                        <option value="Africa/Nairobi" {% if settings.get('timezone') == 'Africa/Nairobi' %}selected{% endif %}>East Africa (Nairobi)</option>
                        <option value="Africa/Kampala" {% if settings.get('timezone') == 'Africa/Kampala' %}selected{% endif %}>East Africa (Kampala)</option>
                        <option value="Africa/Dar_es_Salaam" {% if settings.get('timezone') == 'Africa/Dar_es_Salaam' %}selected{% endif %}>East Africa (Dar es Salaam)</option>
                        <option value="UTC" {% if settings.get('timezone') == 'UTC' %}selected{% endif %}>UTC</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Maintenance Mode -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-tools me-2"></i>
                    Maintenance Mode
                  </h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="maintenance_mode" name="maintenance_mode" {% if settings.get('maintenance_mode') %}checked{% endif %}>
                    <label class="form-check-label" for="maintenance_mode">
                      Enable Maintenance Mode
                    </label>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Maintenance Message</label>
                    <textarea class="form-control" name="maintenance_message" rows="2" placeholder="Message to show during maintenance">{{ settings.get('maintenance_message', 'System is under maintenance. Please try again later.') }}</textarea>
                  </div>
                  <small class="text-muted">When enabled, the system will show this message to all users except admins.</small>
                </div>

                <!-- Backup Settings -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-database me-2"></i>
                    Database Backup
                  </h6>
                  <div class="row g-3">
                    <div class="col-12">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="auto_backup_enabled" id="auto_backup_enabled" {% if settings.get('enabled', True) %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="auto_backup_enabled">
                          Enable Automatic Backups
                        </label>
                        <small class="form-text text-muted d-block">Automatically create backups according to the schedule below</small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Backup Frequency</label>
                      <select class="form-select" name="backup_frequency" id="backup_frequency">
                        <option value="daily" {% if settings.get('frequency') == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if settings.get('frequency', 'weekly') == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if settings.get('frequency') == 'monthly' %}selected{% endif %}>Monthly</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Backup Time</label>
                      <input type="time" class="form-control" name="backup_time" id="backup_time" value="{{ settings.get('time', '02:00') }}">
                      <small class="form-text text-muted">Time in 24-hour format (HH:MM)</small>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="createBackup()">
                      <i class="bi bi-download me-1"></i>
                      Create Manual Backup
                    </button>
                  </div>
                </div>

                <!-- Backup Management -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-archive me-2"></i>
                    Backup Management
                  </h6>
                  <div class="mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadBackups()">
                      <i class="bi bi-arrow-clockwise me-1"></i>
                      Refresh Backup List
                    </button>
                  </div>
                  <div id="backups-list" class="border rounded p-3" style="min-height: 100px;">
                    <div class="text-muted text-center">
                      <i class="bi bi-info-circle me-2"></i>
                      Click "Refresh Backup List" to load available backups
                    </div>
                  </div>
                </div>

                <!-- System Logs -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    System Logs
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Log Level</label>
                      <select class="form-select" name="log_level">
                        <option value="DEBUG" {% if settings.get('log_level') == 'DEBUG' %}selected{% endif %}>Debug</option>
                        <option value="INFO" {% if settings.get('log_level', 'INFO') == 'INFO' %}selected{% endif %}>Info</option>
                        <option value="WARNING" {% if settings.get('log_level') == 'WARNING' %}selected{% endif %}>Warning</option>
                        <option value="ERROR" {% if settings.get('log_level') == 'ERROR' %}selected{% endif %}>Error</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Log Retention (days)</label>
                      <input type="number" class="form-control" name="log_retention" value="{{ settings.get('log_retention', 30) }}" min="1" max="365">
                    </div>
                  </div>
                </div>

                <!-- Performance Settings -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Performance
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="cache_enabled" name="cache_enabled" {% if settings.get('cache_enabled', True) %}checked{% endif %}>
                        <label class="form-check-label" for="cache_enabled">
                          Enable Caching
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Max File Upload Size (MB)</label>
                      <input type="number" class="form-control" name="max_upload_size" value="{{ settings.get('upload_max_size', 10) }}" min="1" max="100">
                    </div>
                  </div>
                </div>

                <!-- Security Settings -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-shield me-2"></i>
                    Security
                  </h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="force_https" name="force_https" {% if settings.get('https_enforced') %}checked{% endif %}>
                    <label class="form-check-label" for="force_https">
                      Force HTTPS
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="enable_cors" name="enable_cors" {% if settings.get('cors_enabled') %}checked{% endif %}>
                    <label class="form-check-label" for="enable_cors">
                      Enable CORS
                    </label>
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>
                    Save Settings
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Bootstrap Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
          <div class="modal-header bg-primary text-white" style="border-radius: 15px 15px 0 0; border-bottom: none;">
            <h5 class="modal-title" id="confirmationModalLabel">
              <i class="bi bi-question-circle me-2"></i>
              Confirm Action
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center p-4">
            <div class="mb-3">
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            </div>
            <p class="mb-0" id="confirmationMessage" style="font-size: 1.1rem; color: #4a5568;"></p>
          </div>
          <div class="modal-footer justify-content-center" style="border-top: none; padding: 1.5rem;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 25px; padding: 8px 25px; margin: 0 5px;">
              <i class="bi bi-x-circle me-1"></i>
              Cancel
            </button>
            <button type="button" class="btn" id="confirmButton" style="border-radius: 25px; padding: 8px 25px; margin: 0 5px;">
              <i class="bi bi-check-circle me-1"></i>
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables for modal callbacks
      let confirmCallback = null;

      function showConfirmationModal(message, confirmText, confirmClass, callback) {
        document.getElementById('confirmationMessage').textContent = message;
        const confirmButton = document.getElementById('confirmButton');
        confirmButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>' + confirmText;
        confirmButton.className = `btn ${confirmClass}`;
        confirmCallback = callback;

        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
      }

      function executeConfirmation() {
        if (confirmCallback) {
          confirmCallback();
          confirmCallback = null;
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
        modal.hide();
      }

      // Initialize modal event listeners
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('confirmButton').addEventListener('click', executeConfirmation);
      });

      // Bootstrap alert functions
      function showAlert(message, type = 'success') {
        const alertsContainer = document.getElementById('alerts-container');
        const alertId = 'alert-' + Date.now();

        const alertHtml = `
          <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;

        alertsContainer.insertAdjacentHTML('beforeend', alertHtml);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          const alertElement = document.getElementById(alertId);
          if (alertElement) {
            alertElement.remove();
          }
        }, 5000);
      }

      function createBackup() {
        showConfirmationModal(
          'Create a manual database backup? This may take a few moments.',
          'Create Backup',
          'btn-primary',
          function() {
            const button = document.querySelector('.btn-outline-primary');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Creating Backup...';

            fetch('/admin/create_backup', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showAlert(`Backup created successfully: ${data.filename} (${data.size} bytes)`, 'success');
                loadBackups(); // Refresh the backup list
              } else {
                showAlert(data.message, 'danger');
              }
            })
            .catch(error => {
              showAlert('Error creating backup: ' + error.message, 'danger');
            })
            .finally(() => {
              button.disabled = false;
              button.innerHTML = originalText;
            });
          }
        );
      }

      function loadBackups() {
        const backupsList = document.getElementById('backups-list');
        backupsList.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split me-2"></i>Loading backups...</div>';

        fetch('/admin/list_backups')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.backups.length === 0) {
              backupsList.innerHTML = '<div class="text-muted text-center"><i class="bi bi-info-circle me-2"></i>No backups found</div>';
              return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
            html += '<thead><tr><th>Filename</th><th>Size</th><th>Created</th><th>Actions</th></tr></thead><tbody>';

            data.backups.forEach(backup => {
              html += `
                <tr>
                  <td>${backup.filename}</td>
                  <td>${backup.size_formatted}</td>
                  <td>${backup.created}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="downloadBackup('${backup.filename}')">
                      <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.filename}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });

            html += '</tbody></table></div>';
            backupsList.innerHTML = html;
          } else {
            backupsList.innerHTML = `<div class="text-danger text-center"><i class="bi bi-exclamation-triangle me-2"></i>${data.message}</div>`;
          }
        })
        .catch(error => {
          backupsList.innerHTML = `<div class="text-danger text-center"><i class="bi bi-exclamation-triangle me-2"></i>Error loading backups: ${error.message}</div>`;
        });
      }

      function downloadBackup(filename) {
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        link.href = `/admin/download_backup/${filename}`;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function deleteBackup(filename) {
        showConfirmationModal(
          `Delete backup "${filename}"? This action cannot be undone.`,
          'Delete Backup',
          'btn-danger',
          function() {
            // Try DELETE first, fallback to POST if it fails
            fetch(`/admin/delete_backup/${filename}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
              }
            })
            .then(response => {
              if (!response.ok) {
                // If DELETE fails, try POST as fallback
                throw new Error('DELETE failed, trying POST');
              }
              return response.json();
            })
            .catch(() => {
              // Fallback to POST method
              return fetch(`/admin/delete_backup/${filename}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ _method: 'DELETE' })
              }).then(response => response.json());
            })
            .then(data => {
              if (data.success) {
                showAlert(data.message, 'success');
                loadBackups(); // Refresh the list
              } else {
                showAlert(data.message, 'danger');
              }
            })
            .catch(error => {
              showAlert('Error deleting backup: ' + error.message, 'danger');
            });
          }
        );
      }

      // Load backups on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
      });

      // Dynamic navbar spacing
      function adjustNavbarSpacing() {
        const navbar = document.querySelector('.navbar');
        const spacer = document.querySelector('.navbar-fixed-top-spacer');
        const mainContent = document.getElementById('main-content');

        if (navbar && spacer) {
          const navbarHeight = navbar.offsetHeight;
          spacer.style.height = navbarHeight + 'px';
          mainContent.style.paddingTop = '1rem'; // Add small additional padding
        }
      }

      // Adjust spacing on load
      adjustNavbarSpacing();

      // Adjust spacing on window resize
      window.addEventListener('resize', adjustNavbarSpacing);

      // Adjust spacing after any dynamic content changes
      const observer = new MutationObserver(adjustNavbarSpacing);
      observer.observe(document.querySelector('.navbar'), {
        attributes: true,
        childList: true,
        subtree: true
      });

      // Automatic Backup Settings
      function toggleAutoBackupSettings() {
        const enabled = document.getElementById('auto_backup_enabled').checked;
        const frequencySelect = document.getElementById('backup_frequency');
        const timeInput = document.getElementById('backup_time');

        frequencySelect.disabled = !enabled;
        timeInput.disabled = !enabled;

        if (enabled) {
          frequencySelect.closest('.col-md-6').classList.remove('opacity-50');
          timeInput.closest('.col-md-6').classList.remove('opacity-50');
        } else {
          frequencySelect.closest('.col-md-6').classList.add('opacity-50');
          timeInput.closest('.col-md-6').classList.add('opacity-50');
        }
      }

      // Format time to AM/PM display
      function formatTimeToAMPM(timeString) {
        if (!timeString) return '';
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
      }

      // Update time display
      function updateTimeDisplay() {
        const timeInput = document.getElementById('backup_time');
        const timeValue = timeInput.value;
        const formattedTime = formatTimeToAMPM(timeValue);

        // Update the small text below the input
        let helpText = timeInput.parentNode.querySelector('.form-text');
        if (helpText) {
          helpText.textContent = formattedTime ? `Time in 24-hour format (HH:MM) - ${formattedTime}` : 'Time in 24-hour format (HH:MM)';
        }
      }

      // Initialize automatic backup settings on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
        toggleAutoBackupSettings(); // Set initial state
        updateTimeDisplay(); // Set initial time display

        // Add event listeners
        document.getElementById('auto_backup_enabled').addEventListener('change', toggleAutoBackupSettings);
        document.getElementById('backup_time').addEventListener('input', updateTimeDisplay);
        document.getElementById('backup_time').addEventListener('change', updateTimeDisplay);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'base.html' %}
  </body>
</html>