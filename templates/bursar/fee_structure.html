<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fee Structure - Bursar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      .bi-spin {
        animation: bi-spin 1s linear infinite;
      }
      @keyframes bi-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .nav-actions { gap: .25rem; display: flex; flex-wrap: nowrap; align-items: center; }
      .nav-actions .btn { white-space: nowrap; flex: 0 0 auto; padding-top: .25rem; padding-bottom: .25rem; }
      .content-offset { padding-top: calc(56px + 7px) !important; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
          {{ system_settings.abbreviated_school_name }}
        </a>
        <div class="ms-auto nav-actions">
          <a href="{{ url_for('bursar.dashboard') }}" class="btn btn-light btn-sm d-flex align-items-center px-2 py-1">
            <i class="bi bi-speedometer2 me-1"></i> Dashboard
          </a>
          <a href="{{ url_for('user.logout') }}" class="btn btn-danger btn-sm text-white d-flex align-items-center px-2 py-1">
            <i class="bi bi-box-arrow-right me-1"></i> Logout
          </a>
        </div>
      </div>
    </nav>

    <main class="container-fluid px-2 px-md-3 py-3 content-offset">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h2 class="mb-0" style="font-size: 1.5rem;">
          <i class="bi bi-gear me-2"></i>
          Fee Structure Management
        </h2>
        <div class="d-flex gap-2">
          <button id="editBtn" class="btn btn-warning btn-sm" onclick="toggleEditMode()">
            <i class="bi bi-pencil me-1"></i>Edit Mode
          </button>
          <button id="saveBtn" class="btn btn-success btn-sm d-none" onclick="saveChanges()">
            <i class="bi bi-check-circle me-1"></i>Save Changes
          </button>
          <button id="cancelBtn" class="btn btn-secondary btn-sm d-none" onclick="cancelEdit()">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="card shadow-sm mb-3">
        <div class="card-body p-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" style="font-size: 0.9rem;">Academic Year</label>
              <select id="academicYearSelector" class="form-select" onchange="loadFeeStructure()">
                <option value="">Choose academic year...</option>
                {% for ay in academic_years %}
                <option value="{{ ay.id }}" {% if ay.is_current %}selected{% endif %}>{{ ay.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size: 0.9rem;">Class</label>
              <select id="classSelector" class="form-select" onchange="loadFeeStructure()">
                <option value="">Choose a class...</option>
                {% for cls in classes %}
                <option value="{{ cls.id }}">{{ cls.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <div class="text-muted" style="font-size: 0.8rem;">
                <i class="bi bi-info-circle me-1"></i>
                Select academic year and class to view and edit fee structures. Both filters are required.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fee Structure Display -->
      <div id="feeStructureCard" class="card shadow-sm d-none" style="background-color: #f0f8ff;">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-cash me-2"></i>
              Fee Structure for <span id="selectedFilters"></span>
            </h5>
            <div class="d-flex align-items-center gap-3">
              <label class="text-white me-2" style="font-size: 0.9rem;">Select Term:</label>
              <select id="termSelector" class="form-select form-select-sm" style="width: auto;">
                <option value="">All Terms</option>
                {% for term in terms %}
                <option value="{{ term.term_number }}">{{ term.name }}</option>
                {% endfor %}
              </select>
              <button id="loadBtn" class="btn btn-light btn-sm" onclick="loadFeeStructureWithTerm()">
                <i class="bi bi-search me-1"></i>Load
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-2 p-md-3">
          <div id="feeStructureContent">
            <div class="text-center py-4">
              <i class="bi bi-arrow-repeat bi-spin fa-2x text-primary mb-3"></i>
              <p class="text-muted">Loading fee structure...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show mt-3" role="alert">
              <small>{{ message }}</small>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let isEditMode = false;
      let originalData = {};
      const terms = [
        {% for term in terms %}
        {id: {{ term.term_number }}, name: '{{ term.name }}'}{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      function loadFeeStructure() {
        loadFeeStructureWithTerm();
      }

      function loadFeeStructureWithTerm() {
        const academicYearId = document.getElementById('academicYearSelector').value;
        const classId = document.getElementById('classSelector').value;
        const termId = document.getElementById('termSelector').value;

        // Check if both academic year and class are selected
        if (!academicYearId || !classId) {
          document.getElementById('feeStructureCard').classList.add('d-none');
          return;
        }

        const academicYearName = document.getElementById('academicYearSelector').options[document.getElementById('academicYearSelector').selectedIndex].text;
        const className = document.getElementById('classSelector').options[document.getElementById('classSelector').selectedIndex].text;

        document.getElementById('selectedFilters').textContent = `${academicYearName} - ${className}`;
        document.getElementById('feeStructureCard').classList.remove('d-none');
        document.getElementById('feeStructureContent').innerHTML = `
          <div class="text-center py-4">
            <i class="bi bi-arrow-repeat bi-spin fa-2x text-primary mb-3"></i>
            <p class="text-muted">Loading fee structure...</p>
          </div>
        `;

        let url = `/bursar/get_fee_structure/${academicYearId}/${classId}`;
        if (termId) {
          url += `?term=${termId}`;
        }

        fetch(url)
          .then(response => response.json())
          .then(data => {
            displayFeeStructure(data.fee_structures, data.fee_categories);
          })
          .catch(error => {
            console.error('Error loading fee structure:', error);
            document.getElementById('feeStructureContent').innerHTML = `
              <div class="text-center py-4">
                <i class="bi bi-exclamation-triangle fa-2x text-danger mb-3"></i>
                <h6 class="text-danger">Error loading fee structure</h6>
                <p class="text-muted">Please try again later.</p>
              </div>
            `;
          });
      }


      function displayFeeStructure(feeStructures, feeCategories) {
        if (feeStructures.length === 0) {
          document.getElementById('feeStructureContent').innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-info-circle fa-2x text-muted mb-3"></i>
              <h6 class="text-muted">No Fee Structures Found</h6>
              <p class="text-muted mb-0" style="font-size: 0.9rem;">No fee structures have been set up for this class yet.</p>
              <button class="btn btn-primary btn-sm mt-3" onclick="addNewFeeStructure()">
                <i class="bi bi-plus-circle me-1"></i>Add Fee Structure
              </button>
            </div>
          `;
          return;
        }

        let html = `
          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
              <thead class="table-dark">
                <tr>
                  <th style="font-size: 0.9rem;">Fee Category</th>
                  ${terms.map(term => `<th style="font-size: 0.9rem;" data-term="${term.id}">${term.name}</th>`).join('')}
                  <th style="font-size: 0.9rem;">Annual Total</th>
                </tr>
              </thead>
              <tbody>
        `;

        feeStructures.forEach(fee => {
          const term1Id = `term1_${fee.id}`;
          const term2Id = `term2_${fee.id}`;
          const term3Id = `term3_${fee.id}`;
          const annualId = `annual_${fee.id}`;

          html += `
            <tr>
              <td style="font-size: 0.85rem;">${fee.category_name}</td>
              <td data-term="1">
                <input type="number" id="${term1Id}" class="form-control form-control-sm term-input" 
                       data-fee-id="${fee.id}" data-term="1"
                       value="${Math.round(fee.term1_amount || 0)}" step="1" min="0" readonly 
                       style="font-size: 0.8rem;">
              </td>
              <td data-term="2">
                <input type="number" id="${term2Id}" class="form-control form-control-sm term-input" 
                       data-fee-id="${fee.id}" data-term="2"
                       value="${Math.round(fee.term2_amount || 0)}" step="1" min="0" readonly 
                       style="font-size: 0.8rem;">
              </td>
              <td data-term="3">
                <input type="number" id="${term3Id}" class="form-control form-control-sm term-input" 
                       data-fee-id="${fee.id}" data-term="3"
                       value="${Math.round(fee.term3_amount || 0)}" step="1" min="0" readonly 
                       style="font-size: 0.8rem;">
              </td>
              <td>
                <input type="number" id="${annualId}" class="form-control form-control-sm fw-bold" 
                       value="${Math.round(fee.annual_amount || 0)}" step="1" min="0" readonly 
                       style="font-size: 0.8rem;">
              </td>
            </tr>
          `;

          // Store original data
          originalData[fee.id] = {
            term1_amount: Math.round(fee.term1_amount || 0),
            term2_amount: Math.round(fee.term2_amount || 0),
            term3_amount: Math.round(fee.term3_amount || 0),
            annual_amount: Math.round(fee.annual_amount || 0)
          };
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        document.getElementById('feeStructureContent').innerHTML = html;

        // Add event listeners for auto-calculation
        setupAutoCalculation();

        // Add event listeners for edit mode
        setupEditModeListeners();
      }

      function setupEditModeListeners() {
        // No additional listeners needed for term selector since filtering is now backend-based
      }

      function setupAutoCalculation() {
        const termInputs = document.querySelectorAll('.term-input');
        termInputs.forEach(input => {
          input.addEventListener('input', function() {
            const feeId = this.getAttribute('data-fee-id');
            calculateAnnualTotal(feeId);
          });
        });
      }

      function calculateAnnualTotal(feeId) {
        const term1 = parseInt(document.getElementById(`term1_${feeId}`).value) || 0;
        const term2 = parseInt(document.getElementById(`term2_${feeId}`).value) || 0;
        const term3 = parseInt(document.getElementById(`term3_${feeId}`).value) || 0;
        const annual = term1 + term2 + term3;

        document.getElementById(`annual_${feeId}`).value = annual;
      }

      function toggleEditMode() {
        isEditMode = !isEditMode;
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const inputs = document.querySelectorAll('#feeStructureContent input[type="number"]');

        if (isEditMode) {
          // Enable edit mode
          inputs.forEach(input => input.removeAttribute('readonly'));
          editBtn.innerHTML = '<i class="bi bi-eye me-1"></i>View Mode';
          editBtn.classList.remove('btn-warning');
          editBtn.classList.add('btn-info');
          saveBtn.classList.remove('d-none');
          cancelBtn.classList.remove('d-none');
          showMessage('Edit mode enabled. You can now edit the fee amounts.', 'info');
        } else {
          // Disable edit mode
          inputs.forEach(input => input.setAttribute('readonly', 'readonly'));
          editBtn.innerHTML = '<i class="bi bi-pencil me-1"></i>Edit Mode';
          editBtn.classList.remove('btn-info');
          editBtn.classList.add('btn-warning');
          saveBtn.classList.add('d-none');
          cancelBtn.classList.add('d-none');
          showMessage('View mode enabled. Fee amounts are now read-only.', 'info');
        }
      }

      function saveChanges() {
        const classId = document.getElementById('classSelector').value;
        const updates = [];

        Object.keys(originalData).forEach(feeId => {
          const term1 = parseInt(document.getElementById(`term1_${feeId}`).value) || 0;
          const term2 = parseInt(document.getElementById(`term2_${feeId}`).value) || 0;
          const term3 = parseInt(document.getElementById(`term3_${feeId}`).value) || 0;
          const annual = term1 + term2 + term3; // Calculate annual total from terms

          if (term1 !== originalData[feeId].term1_amount ||
              term2 !== originalData[feeId].term2_amount ||
              term3 !== originalData[feeId].term3_amount ||
              annual !== originalData[feeId].annual_amount) {
            updates.push({
              id: feeId,
              term1_amount: term1,
              term2_amount: term2,
              term3_amount: term3,
              annual_amount: annual
            });
          }
        });

        if (updates.length === 0) {
          showMessage('No changes to save.', 'info');
          toggleEditMode();
          return;
        }

        fetch('/bursar/update_fee_structures', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ updates: updates })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showMessage('Fee structures updated successfully!', 'success');
            // Update original data
            updates.forEach(update => {
              originalData[update.id] = {
                term1_amount: update.term1_amount,
                term2_amount: update.term2_amount,
                term3_amount: update.term3_amount,
                annual_amount: update.annual_amount
              };
            });
            toggleEditMode();
            loadFeeStructure(); // Reload to get updated data
          } else {
            showMessage('Error updating fee structures: ' + (data.error || 'Unknown error'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error saving changes:', error);
          showMessage('Error saving changes. Please try again.', 'danger');
        });
      }

      function cancelEdit() {
        // Restore original values
        Object.keys(originalData).forEach(feeId => {
          document.getElementById(`term1_${feeId}`).value = originalData[feeId].term1_amount;
          document.getElementById(`term2_${feeId}`).value = originalData[feeId].term2_amount;
          document.getElementById(`term3_${feeId}`).value = originalData[feeId].term3_amount;
          document.getElementById(`annual_${feeId}`).value = originalData[feeId].annual_amount;
        });
        toggleEditMode();
        showMessage('Changes cancelled.', 'info');
      }

      function addNewFeeStructure() {
        showMessage('Add new fee structure functionality not implemented yet.', 'info');
      }

      function showMessage(message, type) {
        // Remove existing messages
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
          <small>${message}</small>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const main = document.querySelector('main');
        main.insertBefore(alertDiv, main.firstChild);

        // Auto-hide after 2 seconds
        setTimeout(() => {
          if (alertDiv) {
            alertDiv.remove();
          }
        }, 2000);
      }

      // Auto-hide flash messages after 3 seconds
      document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          setTimeout(() => {
            if (alert) {
              alert.style.display = 'none';
            }
          }, 2000);
        });
      });
    </script>
    {% include 'base.html' %}
  </body>
</html>