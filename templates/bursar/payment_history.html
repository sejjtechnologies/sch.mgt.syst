<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Payment History - Bursar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning">
      <div class="container-fluid px-2 px-md-3">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
          {{ system_settings.abbreviated_school_name }}
        </a>
        <div class="ms-auto d-flex align-items-center gap-1 gap-md-2">
          <a href="{{ url_for('bursar.dashboard') }}" class="btn btn-light btn-sm d-flex align-items-center">
            <i class="bi bi-speedometer2 me-1"></i>
            <span>Dashboard</span>
          </a>
          <a href="{{ url_for('user.logout') }}" class="btn btn-danger btn-sm text-white d-flex align-items-center px-2 py-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M10 15a1 1 0 0 0 1-1v-2h-1v2H2V2h8v2h1V2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8z"/>
              <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L14.293 7.5H6.5a.5.5 0 0 0 0 1h7.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </nav>

    <main class="container-fluid px-2 px-md-3 py-3">
      {% set used_methods = [] %}
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h2 class="mb-0" style="font-size: 1.5rem;">
          <i class="bi bi-receipt me-2"></i>
          Payment History
        </h2>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="refreshPayments()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="exportToCSV()">
            <i class="bi bi-download me-1"></i>Export CSV
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="card shadow-sm mb-3">
        <div class="card-body p-2 p-md-3">
          <div class="row g-2 g-md-3">
            <div class="col-12 col-md-3">
              <label class="form-label" style="font-size: 0.9rem;">Payment Method</label>
              <select id="paymentMethodFilter" class="form-select" onchange="filterPayments()">
                <option value="">All Methods</option>
                {% for method in payment_methods %}
                <option value="{{ method }}">{{ method }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" style="font-size: 0.9rem;">Term</label>
              <select id="termFilter" class="form-select" onchange="filterPayments()">
                <option value="">All Terms</option>
                {% for term in terms %}
                <option value="{{ term.term_number }}">{{ term.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" style="font-size: 0.9rem;">Academic Year</label>
              <select id="academicYearFilter" class="form-select" onchange="filterPayments()">
                <option value="">All Years</option>
                {% for year in academic_years %}
                <option value="{{ year.name }}">{{ year.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <label class="form-label" style="font-size: 0.9rem;"></label>
              <input type="text" id="studentSearch" class="form-control" placeholder="Search across all payment details..." onkeyup="filterPayments()">
            </div>
          </div>
        </div>
      </div>

      <!-- Payment History Table -->
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white py-2">
          <h5 class="mb-0">
            <i class="bi bi-table me-2"></i>
            Recent Payments
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
              <thead class="table-dark">
                <tr>
                  <th style="font-size: 0.85rem; min-width: 120px;">Student</th>
                  <th style="font-size: 0.85rem; min-width: 100px;">Admission No.</th>
                  <th style="font-size: 0.85rem; min-width: 80px;">Class</th>
                  <th style="font-size: 0.85rem; min-width: 90px;">Academic Year</th>
                  <th style="font-size: 0.85rem; min-width: 60px;">Term</th>
                  <th style="font-size: 0.85rem; min-width: 100px;">Amount</th>
                  <th style="font-size: 0.85rem; min-width: 120px;">Payment Method</th>
                  <th style="font-size: 0.85rem; min-width: 100px;">Receipt No.</th>
                  <th style="font-size: 0.85rem; min-width: 120px;">Transaction Ref.</th>
                  <th style="font-size: 0.85rem; min-width: 140px;">Recorded Time (EAT)</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody">
                {% for payment in payments %}
                <tr>
                  <td style="font-size: 0.8rem;">{{ payment.pupil.first_name }} {{ payment.pupil.last_name }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.pupil.admission_number or 'N/A' }}</td>
                  <td style="font-size: 0.8rem;">{{ class_names.get(payment.pupil.class_admitted, payment.pupil.class_admitted or 'N/A') }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.academic_year.name if payment.academic_year else 'N/A' }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.term }}</td>
                  <td style="font-size: 0.8rem; font-weight: 500;">{{ payment.amount_formatted }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.payment_method }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.receipt_number or '-' }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.transaction_reference or '-' }}</td>
                  <td style="font-size: 0.8rem;">{{ payment.recorded_at_eat }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show mt-3" role="alert">
              <small>{{ message }}</small>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let allPayments = [
        {% for payment in payments %}
        {
          id: {{ payment.id }},
          studentName: '{{ payment.pupil.first_name }} {{ payment.pupil.last_name }}',
          admissionNumber: '{{ payment.pupil.admission_number or '' }}',
          className: '{{ class_names.get(payment.pupil.class_admitted, payment.pupil.class_admitted or '') }}',
          academicYear: '{{ payment.academic_year.name if payment.academic_year else '' }}',
          term: {{ payment.term }},
          amount: {{ payment.amount }},
          amountFormatted: '{{ payment.amount_formatted }}',
          paymentMethod: '{{ payment.payment_method }}',
          receiptNumber: '{{ payment.receipt_number or '' }}',
          transactionRef: '{{ payment.transaction_reference or '' }}',
          recordedTime: '{{ payment.recorded_at_system_tz }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      function refreshPayments() {
        location.reload();
      }

      function filterPayments() {
        const paymentMethod = document.getElementById('paymentMethodFilter').value.toLowerCase();
        const term = document.getElementById('termFilter').value;
        const academicYear = document.getElementById('academicYearFilter').value;
        const studentSearch = document.getElementById('studentSearch').value.toLowerCase();

        const tbody = document.getElementById('paymentsTableBody');
        tbody.innerHTML = '';

        let visibleCount = 0;

        allPayments.forEach(payment => {
          let show = true;

          // Payment method filter
          if (paymentMethod && !payment.paymentMethod.toLowerCase().includes(paymentMethod)) show = false;

          // Term filter
          if (term && payment.term != term) show = false;

          // Academic year filter
          if (academicYear && payment.academicYear !== academicYear) show = false;

          // Search filter - search across all fields
          if (studentSearch) {
            const searchText = (
              payment.studentName + ' ' +
              payment.admissionNumber + ' ' +
              payment.className + ' ' +
              payment.academicYear + ' ' +
              payment.term + ' ' +
              payment.amount + ' ' +
              payment.paymentMethod + ' ' +
              payment.receiptNumber + ' ' +
              payment.transactionRef + ' ' +
              payment.recordedTime
            ).toLowerCase();
            if (!searchText.includes(studentSearch)) show = false;
          }

          if (show) {
            visibleCount++;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="font-size: 0.8rem;">${payment.studentName}</td>
              <td style="font-size: 0.8rem;">${payment.admissionNumber || 'N/A'}</td>
              <td style="font-size: 0.8rem;">${payment.className || 'N/A'}</td>
              <td style="font-size: 0.8rem;">${payment.academicYear || 'N/A'}</td>
              <td style="font-size: 0.8rem;">${payment.term}</td>
              <td style="font-size: 0.8rem; font-weight: 500;">${payment.amountFormatted}</td>
              <td style="font-size: 0.8rem;">${payment.paymentMethod}</td>
              <td style="font-size: 0.8rem;">${payment.receiptNumber || '-'}</td>
              <td style="font-size: 0.8rem;">${payment.transactionRef || '-'}</td>
              <td style="font-size: 0.8rem;">${payment.recordedTime}</td>
            `;
            tbody.appendChild(row);
          }
        });

        // Show message if no results
        if (visibleCount === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="10" class="text-center py-4">
                <i class="bi bi-search fa-2x text-muted mb-3"></i>
                <h6 class="text-muted">No payments match your filters</h6>
                <p class="text-muted">Try adjusting your search criteria.</p>
              </td>
            </tr>
          `;
        }
      }

      function exportToCSV() {
        const headers = ['Student Name', 'Admission Number', 'Class', 'Academic Year', 'Term', 'Amount', 'Payment Method', 'Receipt Number', 'Transaction Reference', 'Recorded Time ({{ system_settings.timezone }})'];
        let csvContent = headers.join(',') + '\n';

        // Get visible rows (filtered results)
        const rows = document.querySelectorAll('#paymentsTableBody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length === 10) { // Skip the "no results" message row
            const rowData = [];
            cells.forEach(cell => {
              let text = cell.textContent.trim();
              // Remove UGX prefix and format numbers
              text = text.replace('UGX ', '').replace(/,/g, '');
              // Escape quotes and wrap in quotes if contains comma
              if (text.includes(',')) {
                text = '"' + text.replace(/"/g, '""') + '"';
              }
              rowData.push(text);
            });
            csvContent += rowData.join(',') + '\n';
          }
        });

        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'payment_history.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Auto-hide alerts
      document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          setTimeout(() => {
            if (alert) {
              alert.style.display = 'none';
            }
          }, 2000);
        });
      });
    </script>
    {% include 'base.html' %}
  </body>
</html>