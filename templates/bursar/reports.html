<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reports - Bursar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
          Bursar
        </a>
        <div class="ms-auto d-flex align-items-center">
          <a href="{{ url_for('bursar.dashboard') }}" class="btn btn-light btn-sm text-dark d-flex align-items-center px-2 py-1 me-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-house me-1" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5z"/>
            </svg>
            Dashboard
          </a>
          <a href="{{ url_for('user.logout') }}" class="btn btn-danger btn-sm text-white d-flex align-items-center px-2 py-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M10 15a1 1 0 0 0 1-1v-2h-1v2H2V2h8v2h1V2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8z"/>
              <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L14.293 7.5H6.5a.5.5 0 0 0 0 1h7.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            Logout
          </a>
        </div>
      </div>
    </nav>

    <main class="container-fluid px-2 px-md-3 py-3">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Financial Reports
              </h5>
            </div>
            <div class="card-body">
              <!-- Report Filters -->
              <div class="row g-2 g-md-3 mb-4">
                <div class="col-12 col-sm-6 col-md-3">
                  <label class="form-label" style="font-size: 0.9rem;">Report Type</label>
                  <select class="form-select" id="reportType">
                    <option value="payments">Payment Summary</option>
                    <option value="outstanding">Outstanding Fees</option>
                    <option value="revenue">Revenue Analysis</option>
                    <option value="class">Class-wise Collection</option>
                  </select>
                </div>

                <div class="col-12 col-sm-6 col-md-3">
                  <label class="form-label" style="font-size: 0.9rem;">Academic Year</label>
                  <select class="form-select" id="academicYear">
                    {% for year in academic_years %}
                    <option value="{{ year.id }}" {% if year.is_active %}selected{% endif %}>{{ year.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 col-sm-6 col-md-3">
                  <label class="form-label" style="font-size: 0.9rem;">Term</label>
                  <select class="form-select" id="term">
                    <option value="">All Terms</option>
                    {% for term in terms %}
                    <option value="{{ term.term_number }}">{{ term.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 col-sm-6 col-md-3">
                  <label class="form-label" style="font-size: 0.9rem;">&nbsp;</label>
                  <div class="d-grid">
                    <button class="btn btn-primary btn-sm" id="generateReport">
                      <i class="fas fa-search me-2"></i>
                      Generate Report
                    </button>
                  </div>
                </div>
              </div>

              <!-- Report Content -->
              <div id="reportContent">
                <!-- Payment Summary Report -->
                <div id="paymentsReport" class="report-section">
                  <h6 class="mb-3">Payment Summary</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <canvas id="paymentsChart"></canvas>
                    </div>
                    <div class="col-md-6">
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Term</th>
                              <th>Total Payments</th>
                              <th>Amount ({{ system_settings.currency }})</th>
                            </tr>
                          </thead>
                          <tbody id="paymentsTableBody">
                            <tr>
                              <td colspan="3" class="text-center text-muted">Select filters and generate report</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Outstanding Fees Report -->
                <div id="outstandingReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Outstanding Fees</h6>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Student Name</th>
                          <th>Class</th>
                          <th>Outstanding Amount</th>
                          <th>Due Date</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="outstandingTableBody">
                        <tr>
                          <td colspan="5" class="text-center text-muted">Select filters and generate report</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Revenue Analysis Report -->
                <div id="revenueReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Revenue Analysis</h6>
                  <div class="row">
                    <div class="col-md-8">
                      <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body">
                          <h6 class="card-title">Summary</h6>
                          <div id="revenueSummary">
                            <p class="mb-1">Total Revenue: <strong id="totalRevenue">-</strong></p>
                            <p class="mb-1">Average per Student: <strong id="avgRevenue">-</strong></p>
                            <p class="mb-0">Collection Rate: <strong id="collectionRate">-</strong></p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Class-wise Collection Report -->
                <div id="classReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Class-wise Collection</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <canvas id="classChart"></canvas>
                    </div>
                    <div class="col-md-6">
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Class</th>
                              <th>Students</th>
                              <th>Total Expected</th>
                              <th>Total Collected</th>
                              <th>% Collected</th>
                            </tr>
                          </thead>
                          <tbody id="classTableBody">
                            <tr>
                              <td colspan="5" class="text-center text-muted">Select filters and generate report</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Export Options -->
              <div class="mt-4">
                <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center justify-content-md-start">
                  <button class="btn btn-outline-primary btn-sm" id="exportPDF">
                    <i class="bi bi-filetype-pdf me-1"></i>
                    <span class="d-none d-sm-inline">Export PDF</span>
                    <span class="d-sm-none">PDF</span>
                  </button>
                  <button class="btn btn-outline-success btn-sm" id="exportExcel">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                    <span class="d-none d-sm-inline">Export Excel</span>
                    <span class="d-sm-none">Excel</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      let currentChart = null;

      // Report generation
      document.getElementById('generateReport').addEventListener('click', function() {
        const reportType = document.getElementById('reportType').value;
        const academicYear = document.getElementById('academicYear').value;
        const term = document.getElementById('term').value;

        // Hide all report sections
        document.querySelectorAll('.report-section').forEach(section => {
          section.style.display = 'none';
        });

        // Show selected report section
        document.getElementById(reportType + 'Report').style.display = 'block';

        // Generate report data
        generateReport(reportType, academicYear, term);
      });

      function generateReport(type, year, term) {
        // This would typically fetch data from the server
        // For now, we'll use mock data

        switch(type) {
          case 'payments':
            generatePaymentsReport(year, term);
            break;
          case 'outstanding':
            generateOutstandingReport(year, term);
            break;
          case 'revenue':
            generateRevenueReport(year, term);
            break;
          case 'class':
            generateClassReport(year, term);
            break;
        }
      }

      function generatePaymentsReport(year, term) {
        // Fetch data from API
        let url = '/bursar/api/payment_summary?academic_year=' + year;
        if (term) url += '&term=' + term;

        fetch(url)
          .then(response => response.json())
          .then(data => {
            // Update table
            const tbody = document.getElementById('paymentsTableBody');
            if (data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No payment data available</td></tr>';
              return;
            }

            tbody.innerHTML = data.map(row => `
              <tr>
                <td>${row.term}</td>
                <td>${row.payments}</td>
                <td>${row.amount.toLocaleString()}</td>
              </tr>
            `).join('');

            // Update chart
            if (currentChart) currentChart.destroy();
            const ctx = document.getElementById('paymentsChart').getContext('2d');
            currentChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: data.map(d => d.term),
                datasets: [{
                  label: 'Amount ({{ system_settings.currency }})',
                  data: data.map(d => d.amount),
                  backgroundColor: 'rgba(54, 162, 235, 0.5)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return value.toLocaleString();
                      }
                    }
                  }
                }
              }
            });
          })
          .catch(error => {
            console.error('Error fetching payment summary:', error);
            document.getElementById('paymentsTableBody').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>';
          });
      }

      function generateOutstandingReport(year, term) {
        // Fetch data from API
        let url = '/bursar/api/outstanding_fees?academic_year=' + year;
        if (term) url += '&term=' + term;

        fetch(url)
          .then(response => response.json())
          .then(data => {
            const tbody = document.getElementById('outstandingTableBody');
            if (data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No outstanding fees</td></tr>';
              return;
            }

            tbody.innerHTML = data.map(row => `
              <tr>
                <td>${row.name}</td>
                <td>${row.class_name}</td>
                <td>${row.outstanding_amount.toLocaleString()}</td>
                <td>${row.due_date}</td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="sendReminder('${row.name}')">
                    <i class="fas fa-bell"></i>
                  </button>
                </td>
              </tr>
            `).join('');
          })
          .catch(error => {
            console.error('Error fetching outstanding fees:', error);
            document.getElementById('outstandingTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
          });
      }

      function generateRevenueReport(year, term) {
        // Fetch data from API
        let url = '/bursar/api/revenue_analysis?academic_year=' + year;
        if (term) url += '&term=' + term;

        fetch(url)
          .then(response => response.json())
          .then(data => {
            document.getElementById('totalRevenue').textContent = data.total_revenue.toLocaleString();
            document.getElementById('avgRevenue').textContent = data.avg_revenue.toLocaleString('en-US', {maximumFractionDigits: 0});
            document.getElementById('collectionRate').textContent = data.collection_rate.toFixed(1) + '%';

            // Revenue chart
            if (currentChart) currentChart.destroy();
            const ctx = document.getElementById('revenueChart').getContext('2d');
            currentChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.monthly_labels,
                datasets: [{
                  label: 'Monthly Revenue',
                  data: data.monthly_data,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  tension: 0.1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return value.toLocaleString();
                      }
                    }
                  }
                }
              }
            });
          })
          .catch(error => {
            console.error('Error fetching revenue analysis:', error);
            document.getElementById('totalRevenue').textContent = 'Error';
            document.getElementById('avgRevenue').textContent = 'Error';
            document.getElementById('collectionRate').textContent = 'Error';
          });
      }

      function generateClassReport(year, term) {
        // Fetch data from API
        let url = '/bursar/api/class_collection?academic_year=' + year;
        if (term) url += '&term=' + term;

        fetch(url)
          .then(response => response.json())
          .then(data => {
            // Update table
            const tbody = document.getElementById('classTableBody');
            if (data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No class data available</td></tr>';
              return;
            }

            tbody.innerHTML = data.map(row => `
              <tr>
                <td>${row.class}</td>
                <td>${row.students}</td>
                <td>${row.expected.toLocaleString()}</td>
                <td>${row.collected.toLocaleString()}</td>
                <td>${row.percentage}%</td>
              </tr>
            `).join('');

            // Update chart
            if (currentChart) currentChart.destroy();
            const ctx = document.getElementById('classChart').getContext('2d');
            currentChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: data.map(d => d.class),
                datasets: [{
                  data: data.map(d => d.percentage),
                  backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 205, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                  ],
                  borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true
              }
            });
          })
          .catch(error => {
            console.error('Error fetching class collection:', error);
            document.getElementById('classTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
          });
      }

      function sendReminder(studentName) {
        alert(`Reminder sent to ${studentName}'s parents`);
      }

      // Export functions
      function exportToCSV(filename = 'report.csv') {
        const reportType = document.getElementById('reportType').value;
        let csv = '';
        let headers = [];
        let rows = [];

        if (reportType === 'payments') {
          headers = ['Term', 'Total Payments', 'Amount ({{ system_settings.currency }})'];
          rows = Array.from(document.querySelectorAll('#paymentsTableBody tr')).map(row => {
            return Array.from(row.querySelectorAll('td')).map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"').join(',');
          });
        } else if (reportType === 'outstanding') {
          headers = ['Student Name', 'Class', 'Outstanding Amount', 'Due Date'];
          rows = Array.from(document.querySelectorAll('#outstandingTableBody tr')).filter(row => row.querySelectorAll('td').length >= 4).map(row => {
            return Array.from(row.querySelectorAll('td')).slice(0, 4).map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"').join(',');
          });
        } else if (reportType === 'revenue') {
          headers = ['Metric', 'Value'];
          rows = [
            '"Total Revenue","' + document.getElementById('totalRevenue').textContent + '"',
            '"Average per Student","' + document.getElementById('avgRevenue').textContent + '"',
            '"Collection Rate","' + document.getElementById('collectionRate').textContent + '"'
          ];
        } else if (reportType === 'class') {
          headers = ['Class', 'Students', 'Total Expected', 'Total Collected', '% Collected'];
          rows = Array.from(document.querySelectorAll('#classTableBody tr')).map(row => {
            return Array.from(row.querySelectorAll('td')).map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"').join(',');
          });
        }

        csv = headers.map(h => '"' + h + '"').join(',') + '\n' + rows.join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function exportToPDF() {
        const reportType = document.getElementById('reportType').value;
        let printWindow = window.open('', '', 'height=600,width=800');
        let content = '<html><head><title>Report</title>';
        content += '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">';
        content += '<style>body { font-family: Arial, sans-serif; margin: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #007bff; color: white; }</style>';
        content += '</head><body>';
        content += '<h2>' + document.getElementById(reportType + 'Report').querySelector('h6').textContent + '</h2>';

        if (reportType === 'revenue') {
          content += '<div class="card p-3"><p><strong>Total Revenue:</strong> ' + document.getElementById('totalRevenue').textContent + '</p>';
          content += '<p><strong>Average per Student:</strong> ' + document.getElementById('avgRevenue').textContent + '</p>';
          content += '<p><strong>Collection Rate:</strong> ' + document.getElementById('collectionRate').textContent + '</p></div>';
        } else {
          content += document.querySelector('#' + reportType + 'Report .table-responsive').innerHTML;
        }

        content += '<p style="margin-top: 30px; font-size: 12px; color: #666;">Generated on ' + new Date().toLocaleString() + '</p>';
        content += '</body></html>';

        printWindow.document.write(content);
        printWindow.document.close();
        setTimeout(() => {
          printWindow.print();
        }, 250);
      }

      // Export button handlers
      document.getElementById('exportPDF').addEventListener('click', function() {
        exportToPDF();
      });

      document.getElementById('exportExcel').addEventListener('click', function() {
        const reportType = document.getElementById('reportType').value;
        exportToCSV('report_' + reportType + '_' + new Date().toISOString().split('T')[0] + '.csv');
      });

      // Initialize with default report
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('generateReport').click();
      });
    </script>
    {% include 'base.html' %}
  </body>
</html>