<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reports - Bursar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <img src="{{ url_for('static', filename='images/school_192.png') }}" alt="School Logo" class="me-2" style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
          Bursar
        </a>
        <div class="ms-auto d-flex align-items-center">
          <a href="{{ url_for('bursar.dashboard') }}" class="btn btn-light btn-sm text-dark d-flex align-items-center px-2 py-1 me-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-house me-1" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5z"/>
            </svg>
            Dashboard
          </a>
          <a href="{{ url_for('user.logout') }}" class="btn btn-danger btn-sm text-white d-flex align-items-center px-2 py-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M10 15a1 1 0 0 0 1-1v-2h-1v2H2V2h8v2h1V2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8z"/>
              <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L14.293 7.5H6.5a.5.5 0 0 0 0 1h7.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            Logout
          </a>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Financial Reports
              </h5>
            </div>
            <div class="card-body">
              <!-- Report Filters -->
              <div class="row g-3 mb-4">
                <div class="col-md-3">
                  <label class="form-label">Report Type</label>
                  <select class="form-select" id="reportType">
                    <option value="payments">Payment Summary</option>
                    <option value="outstanding">Outstanding Fees</option>
                    <option value="revenue">Revenue Analysis</option>
                    <option value="class">Class-wise Collection</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Academic Year</label>
                  <select class="form-select" id="academicYear">
                    <option value="{{ current_year }}">{{ current_year }}</option>
                    <option value="{{ current_year - 1 }}">{{ current_year - 1 }}</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Term</label>
                  <select class="form-select" id="term">
                    <option value="">All Terms</option>
                    {% for term in terms %}
                    <option value="{{ term.term_number }}">{{ term.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <div class="d-grid">
                    <button class="btn btn-primary" id="generateReport">
                      <i class="fas fa-search me-2"></i>
                      Generate Report
                    </button>
                  </div>
                </div>
              </div>

              <!-- Report Content -->
              <div id="reportContent">
                <!-- Payment Summary Report -->
                <div id="paymentsReport" class="report-section">
                  <h6 class="mb-3">Payment Summary</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <canvas id="paymentsChart"></canvas>
                    </div>
                    <div class="col-md-6">
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Term</th>
                              <th>Total Payments</th>
                              <th>Amount (UGX)</th>
                            </tr>
                          </thead>
                          <tbody id="paymentsTableBody">
                            <tr>
                              <td colspan="3" class="text-center text-muted">Select filters and generate report</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Outstanding Fees Report -->
                <div id="outstandingReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Outstanding Fees</h6>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Student Name</th>
                          <th>Class</th>
                          <th>Outstanding Amount</th>
                          <th>Due Date</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="outstandingTableBody">
                        <tr>
                          <td colspan="5" class="text-center text-muted">Select filters and generate report</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Revenue Analysis Report -->
                <div id="revenueReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Revenue Analysis</h6>
                  <div class="row">
                    <div class="col-md-8">
                      <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body">
                          <h6 class="card-title">Summary</h6>
                          <div id="revenueSummary">
                            <p class="mb-1">Total Revenue: <strong id="totalRevenue">-</strong></p>
                            <p class="mb-1">Average per Student: <strong id="avgRevenue">-</strong></p>
                            <p class="mb-0">Collection Rate: <strong id="collectionRate">-</strong></p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Class-wise Collection Report -->
                <div id="classReport" class="report-section" style="display: none;">
                  <h6 class="mb-3">Class-wise Collection</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <canvas id="classChart"></canvas>
                    </div>
                    <div class="col-md-6">
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Class</th>
                              <th>Students</th>
                              <th>Total Expected</th>
                              <th>Total Collected</th>
                              <th>% Collected</th>
                            </tr>
                          </thead>
                          <tbody id="classTableBody">
                            <tr>
                              <td colspan="5" class="text-center text-muted">Select filters and generate report</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Export Options -->
              <div class="mt-4 text-center">
                <button class="btn btn-outline-primary me-2" id="exportPDF">
                  <i class="fas fa-file-pdf me-2"></i>
                  Export PDF
                </button>
                <button class="btn btn-outline-success" id="exportExcel">
                  <i class="fas fa-file-excel me-2"></i>
                  Export Excel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      let currentChart = null;

      // Report generation
      document.getElementById('generateReport').addEventListener('click', function() {
        const reportType = document.getElementById('reportType').value;
        const academicYear = document.getElementById('academicYear').value;
        const term = document.getElementById('term').value;

        // Hide all report sections
        document.querySelectorAll('.report-section').forEach(section => {
          section.style.display = 'none';
        });

        // Show selected report section
        document.getElementById(reportType + 'Report').style.display = 'block';

        // Generate report data
        generateReport(reportType, academicYear, term);
      });

      function generateReport(type, year, term) {
        // This would typically fetch data from the server
        // For now, we'll use mock data

        switch(type) {
          case 'payments':
            generatePaymentsReport(year, term);
            break;
          case 'outstanding':
            generateOutstandingReport(year, term);
            break;
          case 'revenue':
            generateRevenueReport(year, term);
            break;
          case 'class':
            generateClassReport(year, term);
            break;
        }
      }

      function generatePaymentsReport(year, term) {
        // Mock data
        const data = [
          { term: 'Term 1', payments: 150, amount: 4500000 },
          { term: 'Term 2', payments: 145, amount: 4350000 },
          { term: 'Term 3', payments: 148, amount: 4440000 }
        ];

        // Update table
        const tbody = document.getElementById('paymentsTableBody');
        tbody.innerHTML = data.map(row => `
          <tr>
            <td>${row.term}</td>
            <td>${row.payments}</td>
            <td>${row.amount.toLocaleString()}</td>
          </tr>
        `).join('');

        // Update chart
        if (currentChart) currentChart.destroy();
        const ctx = document.getElementById('paymentsChart').getContext('2d');
        currentChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(d => d.term),
            datasets: [{
              label: 'Amount (UGX)',
              data: data.map(d => d.amount),
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      function generateOutstandingReport(year, term) {
        // Mock data
        const data = [
          { name: 'John Doe', class: 'P.1', amount: 50000, dueDate: '2024-02-15' },
          { name: 'Jane Smith', class: 'P.2', amount: 75000, dueDate: '2024-02-20' }
        ];

        const tbody = document.getElementById('outstandingTableBody');
        tbody.innerHTML = data.map(row => `
          <tr>
            <td>${row.name}</td>
            <td>${row.class}</td>
            <td>${row.amount.toLocaleString()}</td>
            <td>${row.dueDate}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="sendReminder('${row.name}')">
                <i class="fas fa-bell"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      function generateRevenueReport(year, term) {
        // Mock data
        const totalRevenue = 13290000;
        const avgRevenue = 442333;
        const collectionRate = '95.2%';

        document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
        document.getElementById('avgRevenue').textContent = avgRevenue.toLocaleString();
        document.getElementById('collectionRate').textContent = collectionRate;

        // Revenue chart
        if (currentChart) currentChart.destroy();
        const ctx = document.getElementById('revenueChart').getContext('2d');
        currentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
              label: 'Monthly Revenue',
              data: [1000000, 1100000, 1050000, 1200000, 1150000, 1300000, 1250000, 1400000, 1350000, 1500000, 1450000, 1600000],
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      function generateClassReport(year, term) {
        // Mock data
        const data = [
          { class: 'P.1', students: 45, expected: 2250000, collected: 2100000, percentage: 93.3 },
          { class: 'P.2', students: 42, expected: 2100000, collected: 2000000, percentage: 95.2 },
          { class: 'P.3', students: 38, expected: 1900000, collected: 1800000, percentage: 94.7 }
        ];

        // Update table
        const tbody = document.getElementById('classTableBody');
        tbody.innerHTML = data.map(row => `
          <tr>
            <td>${row.class}</td>
            <td>${row.students}</td>
            <td>${row.expected.toLocaleString()}</td>
            <td>${row.collected.toLocaleString()}</td>
            <td>${row.percentage}%</td>
          </tr>
        `).join('');

        // Update chart
        if (currentChart) currentChart.destroy();
        const ctx = document.getElementById('classChart').getContext('2d');
        currentChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.map(d => d.class),
            datasets: [{
              data: data.map(d => d.percentage),
              backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 205, 86, 0.5)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true
          }
        });
      }

      function sendReminder(studentName) {
        alert(`Reminder sent to ${studentName}'s parents`);
      }

      // Export functions
      document.getElementById('exportPDF').addEventListener('click', function() {
        alert('PDF export functionality would be implemented here');
      });

      document.getElementById('exportExcel').addEventListener('click', function() {
        alert('Excel export functionality would be implemented here');
      });

      // Initialize with default report
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('generateReport').click();
      });
    </script>
  </body>
</html>